pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'api_produto'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        DOCKER_REGISTRY = '' // Adicione seu registry se necess√°rio (ex: 'docker.io/username')
        APP_PORT = '8080'
        DEPLOY_TO_K8S = 'false' // Altere para 'true' para habilitar deploy no Kubernetes
    }
    
    stages {
        stage('üöÄ Iniciando Pipeline') {
            steps {
                script {
                    echo '=========================================='
                    echo '  Pipeline CI/CD - API Produto'
                    echo '=========================================='
                    echo "Build: #${env.BUILD_NUMBER}"
                    echo "Branch: ${env.GIT_BRANCH}"
                    echo "Commit: ${env.GIT_COMMIT}"
                    echo '=========================================='
                }
            }
        }
        
        stage('üì• Checkout') {
            steps {
                echo 'üì• Clonando reposit√≥rio do Git...'
                checkout scm
                script {
                    echo "‚úÖ C√≥digo fonte obtido com sucesso"
                    sh 'git log -1 --pretty=format:"%h - %an: %s"'
                }
            }
        }
        
        stage('üì¶ Instalando Depend√™ncias') {
            steps {
                echo 'üì¶ Instalando depend√™ncias do Dart...'
                script {
                    sh 'dart --version'
                    sh 'dart pub get'
                    echo '‚úÖ Depend√™ncias instaladas com sucesso'
                }
            }
        }
        
        stage('üîç An√°lise de C√≥digo') {
            steps {
                echo 'üîç Executando an√°lise est√°tica de c√≥digo...'
                script {
                    def analysisResult = sh(
                        script: 'dart analyze --fatal-infos',
                        returnStatus: true
                    )
                    
                    if (analysisResult == 0) {
                        echo '‚úÖ An√°lise de c√≥digo passou sem problemas'
                    } else {
                        error '‚ùå An√°lise de c√≥digo encontrou problemas'
                    }
                }
            }
        }
        
        stage('üß™ Testes Unit√°rios') {
            steps {
                echo 'üß™ Executando testes unit√°rios...'
                script {
                    sh 'dart test --reporter=expanded'
                    echo '‚úÖ Todos os testes passaram'
                }
            }
        }
        
        stage('üìä Cobertura de C√≥digo') {
            steps {
                echo 'üìä Gerando relat√≥rio de cobertura...'
                script {
                    sh '''
                        dart test --coverage=coverage
                        dart pub global activate coverage
                        dart pub global run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
                    '''
                    
                    // Calcular porcentagem de cobertura
                    def coverage = sh(
                        script: '''
                            if [ -f coverage/lcov.info ]; then
                                lines_found=$(grep -o "LF:[0-9]*" coverage/lcov.info | cut -d: -f2 | awk '{s+=$1} END {print s}')
                                lines_hit=$(grep -o "LH:[0-9]*" coverage/lcov.info | cut -d: -f2 | awk '{s+=$1} END {print s}')
                                if [ "$lines_found" -gt 0 ]; then
                                    echo "scale=2; ($lines_hit / $lines_found) * 100" | bc
                                else
                                    echo "0"
                                fi
                            else
                                echo "0"
                            fi
                        ''',
                        returnStdout: true
                    ).trim()
                    
                    echo "‚úÖ Cobertura de c√≥digo: ${coverage}%"
                }
            }
        }
        
        stage('üèóÔ∏è Build da Aplica√ß√£o') {
            steps {
                echo 'üèóÔ∏è Compilando aplica√ß√£o Dart...'
                script {
                    sh 'dart compile exe bin/server.dart -o bin/server'
                    echo '‚úÖ Aplica√ß√£o compilada com sucesso'
                }
            }
        }
        
        stage('üê≥ Build Docker Image') {
            steps {
                echo 'üê≥ Construindo imagem Docker...'
                script {
                    def imageName = env.DOCKER_REGISTRY ? 
                        "${env.DOCKER_REGISTRY}/${env.DOCKER_IMAGE}" : 
                        "${env.DOCKER_IMAGE}"
                    
                    echo "Construindo: ${imageName}:${env.DOCKER_TAG}"
                    docker.build("${imageName}:${env.DOCKER_TAG}")
                    
                    echo "Taggeando como latest: ${imageName}:latest"
                    sh "docker tag ${imageName}:${env.DOCKER_TAG} ${imageName}:latest"
                    
                    echo '‚úÖ Imagem Docker constru√≠da com sucesso'
                    sh "docker images ${imageName}"
                }
            }
        }
        
        stage('üîê Scan de Seguran√ßa') {
            steps {
                echo 'üîê Verificando vulnerabilidades na imagem...'
                script {
                    def imageName = env.DOCKER_REGISTRY ? 
                        "${env.DOCKER_REGISTRY}/${env.DOCKER_IMAGE}:${env.DOCKER_TAG}" : 
                        "${env.DOCKER_IMAGE}:${env.DOCKER_TAG}"
                    
                    // Verificar depend√™ncias desatualizadas
                    sh 'dart pub outdated || true'
                    
                    echo '‚úÖ Scan de seguran√ßa conclu√≠do'
                }
            }
        }
        
        stage('üì§ Push Docker Image') {
            when {
                branch 'main'
            }
            steps {
                echo 'üì§ Enviando imagem para Docker Registry...'
                script {
                    if (env.DOCKER_REGISTRY) {
                        docker.withRegistry('', 'docker-credentials') {
                            def imageName = "${env.DOCKER_REGISTRY}/${env.DOCKER_IMAGE}"
                            
                            echo "Pushing: ${imageName}:${env.DOCKER_TAG}"
                            docker.image("${imageName}:${env.DOCKER_TAG}").push()
                            
                            echo "Pushing: ${imageName}:latest"
                            docker.image("${imageName}:latest").push()
                            
                            echo '‚úÖ Imagem enviada para registry com sucesso'
                        }
                    } else {
                        echo '‚ö†Ô∏è Registry n√£o configurado. Pulando push...'
                    }
                }
            }
        }
        
        stage('üöÄ Deploy') {
            when {
                branch 'main'
            }
            steps {
                echo 'üöÄ Iniciando deploy da aplica√ß√£o...'
                script {
                    // Parar containers antigos
                    echo 'Parando containers antigos...'
                    sh 'docker-compose down || true'
                    
                    // Iniciar novos containers
                    echo 'Iniciando novos containers...'
                    sh 'docker-compose up -d'
                    
                    // Aguardar aplica√ß√£o iniciar
                    echo 'Aguardando aplica√ß√£o iniciar...'
                    sleep 10
                    
                    echo '‚úÖ Deploy conclu√≠do com sucesso'
                }
            }
        }
        
        stage('‚úÖ Health Check') {
            when {
                branch 'main'
            }
            steps {
                echo '‚úÖ Verificando sa√∫de da aplica√ß√£o...'
                script {
                    def maxRetries = 5
                    def retryCount = 0
                    def healthy = false
                    
                    while (retryCount < maxRetries && !healthy) {
                        def response = sh(
                            script: "curl -s -o /dev/null -w '%{http_code}' http://localhost:${env.APP_PORT}/",
                            returnStdout: true
                        ).trim()
                        
                        if (response == '200') {
                            healthy = true
                            echo "‚úÖ Aplica√ß√£o est√° saud√°vel! (Status: ${response})"
                        } else {
                            retryCount++
                            echo "‚ö†Ô∏è Tentativa ${retryCount}/${maxRetries} - Status: ${response}"
                            if (retryCount < maxRetries) {
                                sleep 5
                            }
                        }
                    }
                    
                    if (!healthy) {
                        error '‚ùå Health check falhou ap√≥s m√∫ltiplas tentativas'
                    }
                    
                    // Mostrar logs do container
                    echo 'Logs da aplica√ß√£o:'
                    sh 'docker-compose logs --tail=20 api'
                }
            }
        }
        
        stage('‚ò∏Ô∏è Deploy to Kubernetes') {
            when {
                allOf {
                    branch 'main'
                    environment name: 'DEPLOY_TO_K8S', value: 'true'
                }
            }
            steps {
                echo '‚ò∏Ô∏è Iniciando deploy no Kubernetes...'
                script {
                    // Verificar se kubectl est√° dispon√≠vel
                    def kubectlAvailable = sh(
                        script: 'command -v kubectl',
                        returnStatus: true
                    ) == 0
                    
                    if (!kubectlAvailable) {
                        echo '‚ö†Ô∏è kubectl n√£o encontrado. Pulando deploy K8s...'
                        return
                    }
                    
                    // Verificar conex√£o com cluster
                    def clusterConnected = sh(
                        script: 'kubectl cluster-info',
                        returnStatus: true
                    ) == 0
                    
                    if (!clusterConnected) {
                        echo '‚ö†Ô∏è N√£o conectado ao cluster K8s. Pulando deploy...'
                        return
                    }
                    
                    echo 'Atualizando deployment no Kubernetes...'
                    
                    // Atualizar imagem no deployment
                    def imageName = env.DOCKER_REGISTRY ? 
                        "${env.DOCKER_REGISTRY}/${env.DOCKER_IMAGE}:${env.DOCKER_TAG}" : 
                        "${env.DOCKER_IMAGE}:${env.DOCKER_TAG}"
                    
                    sh """
                        kubectl set image deployment/api-produto \
                            api-produto=${imageName} \
                            -n api-produto
                    """
                    
                    // Aguardar rollout
                    echo 'Aguardando rollout do deployment...'
                    sh 'kubectl rollout status deployment/api-produto -n api-produto --timeout=5m'
                    
                    // Verificar pods
                    echo 'Verificando pods:'
                    sh 'kubectl get pods -n api-produto -l app=api-produto'
                    
                    // Obter URL do servi√ßo
                    def externalIP = sh(
                        script: 'kubectl get svc api-produto-service -n api-produto -o jsonpath=\'{.status.loadBalancer.ingress[0].ip}\' 2>/dev/null || echo "pending"',
                        returnStdout: true
                    ).trim()
                    
                    if (externalIP && externalIP != 'pending') {
                        echo "‚úÖ Deploy K8s conclu√≠do!"
                        echo "URL: http://${externalIP}"
                        echo "Swagger: http://${externalIP}/swagger/"
                    } else {
                        echo '‚úÖ Deploy K8s conclu√≠do! (IP externo pendente)'
                    }
                }
            }
        }
        
        stage('üìã Resumo do Deploy') {
            when {
                branch 'main'
            }
            steps {
                script {
                    echo '=========================================='
                    echo '  Deploy Conclu√≠do com Sucesso!'
                    echo '=========================================='
                    echo "Build: #${env.BUILD_NUMBER}"
                    echo "Imagem: ${env.DOCKER_IMAGE}:${env.DOCKER_TAG}"
                    
                    if (env.DEPLOY_TO_K8S == 'true') {
                        echo "Plataforma: Kubernetes"
                        echo "Namespace: api-produto"
                    } else {
                        echo "Plataforma: Docker Compose"
                        echo "URL: http://localhost:${env.APP_PORT}"
                        echo "Swagger: http://localhost:${env.APP_PORT}/swagger/"
                    }
                    echo '=========================================='
                }
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Limpando workspace...'
            script {
                // Arquivar relat√≥rios
                archiveArtifacts artifacts: 'coverage/**/*', allowEmptyArchive: true
                
                // Publicar relat√≥rio de cobertura se existir
                publishHTML([
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'coverage',
                    reportFiles: 'index.html',
                    reportName: 'Coverage Report'
                ])
            }
            cleanWs()
        }
        success {
            script {
                echo '=========================================='
                echo '  ‚úÖ Pipeline Executado com Sucesso!'
                echo '=========================================='
                echo "Dura√ß√£o: ${currentBuild.durationString}"
                echo "Build: #${env.BUILD_NUMBER}"
                echo '=========================================='
            }
        }
        failure {
            script {
                echo '=========================================='
                echo '  ‚ùå Pipeline Falhou!'
                echo '=========================================='
                echo "Build: #${env.BUILD_NUMBER}"
                echo "Stage: ${env.STAGE_NAME}"
                echo '=========================================='
            }
        }
        unstable {
            echo '‚ö†Ô∏è Pipeline inst√°vel - verifique os warnings'
        }
    }
}
